# 🔋 バッテリー交換実績集計アプリ

PT企業（user_company）毎に、user_nameと自転車メーカー別のバッテリー交換実績を集計し、Excel出力するアプリケーションです。

## 📋 機能

- ✅ Excelファイル（バッテリー交換実績データ）の読み込み
- ✅ PT企業毎に自動集計
- ✅ user_name × 自転車メーカー名 のクロス集計表を生成
- ✅ **基準内/基準外の判定と集計**
- ✅ インタラクティブなグラフ表示（棒グラフ、円グラフ）
- ✅ Excel形式での集計結果ダウンロード
  - 各PT企業単体: 「集計結果」シートと「生データ」シートの2シート構成
  - 全PT企業一括: 集計のみ、または集計+生データから選択可能

## 🚀 セットアップ

### 1. 必要なパッケージのインストール

```bash
pip install -r requirements.txt
```

### 2. アプリケーションの起動

```bash
streamlit run app.py
```

ブラウザが自動的に開き、アプリケーションが表示されます。

## 📖 使い方

### 基本的な使い方

1. **ファイルのアップロード**
   - サイドバーから「Excelファイルをアップロード」ボタンをクリック
   - バッテリー交換実績データのExcelファイルを選択

2. **集計実行**
   - 「🔄 集計実行」ボタンをクリック
   - PT企業毎に自動集計が実行されます

3. **結果の確認**
   - ドロップダウンからPT企業を選択
   - 以下の3つのタブで結果を確認できます：
     - **📋 集計表**: user_name × 自転車メーカー名のクロス集計表（基準内/基準外含む）
     - **📊 グラフ**: 棒グラフと円グラフでビジュアル表示（基準内/基準外の色分け）
     - **💾 Excel出力**: 集計結果と生データをExcelファイルとしてダウンロード

## 📊 データ形式

### 入力データ（Excel）

必須列：
- `user_company(所属)`: PT企業名（V列）
- `user_name`: ユーザー名
- `自転車メーカー名`: 自転車のメーカー名
- `battery_remaining`: バッテリー残量（基準判定に使用）

### 出力データ（集計結果）

各PT企業毎に以下の形式で集計（基準内/基準外含む）：

| user_name | Panasonic_基準内 | Panasonic_基準外 | Panasonic_合計 | YAMAHA_基準内 | YAMAHA_基準外 | YAMAHA_合計 | ... | 総合計 |
|-----------|-----------------|----------------|--------------|-------------|-------------|------------|-----|-------|
| ユーザー1   | 80              | 20             | 100          | 45          | 5           | 50         | ... | 167   |
| ユーザー2   | 70              | 10             | 80           | 55          | 5           | 60         | ... | 159   |
| ...       | ...             | ...            | ...          | ...         | ...         | ...        | ... | ...   |
| 合計      | 150             | 30             | 180          | 100         | 10          | 110        | ... | 326   |

#### バッテリー残量基準

各メーカーの基準外判定：
- **Panasonic**: 25%以上が基準外（25%未満が基準内）
- **YAMAHA**: 70%以上が基準外（70%未満が基準内）
- **DBS**: 50%以上が基準外（ただし100%は基準内）
- **glafit**: 50%以上が基準外（50%未満が基準内）
- **シナネンサイクル**: 40%以上が基準外（40%未満が基準内）
- **KUROAD**: 基準判定なし

### Excel出力形式

#### 各PT企業単体のダウンロード
2つのシートを含むExcelファイル：
1. **集計結果シート**: PT企業の集計表（基準内/基準外含む）
2. **生データシート**: 該当PT企業の全交換記録

#### 全PT企業一括ダウンロード
2つのオプションから選択：
- **集計結果のみ**: 各PT企業の集計表を個別シートに格納
- **集計結果 + 生データ**: 各PT企業毎に集計と生データの両方を格納（ファイルサイズが大きくなります）

## 🛠️ 技術スタック

- **Python 3.9+**
- **Streamlit**: Webアプリケーションフレームワーク
- **Pandas**: データ処理・集計
- **Plotly**: インタラクティブなグラフ表示
- **OpenPyXL**: Excelファイルの読み書き

## 📊 グラフ機能

### メーカー別交換件数（上位10名）
ユーザー別にメーカー毎の交換件数を棒グラフで表示

### 基準内/基準外の内訳
各ユーザーの基準内・基準外の件数を色分けして表示
- 🟢 基準内: 緑色
- 🔴 基準外: 赤色

### メーカー別シェア
PT企業全体でのメーカー別シェアを円グラフで表示

### 基準内/基準外シェア
PT企業全体での基準内・基準外の割合を円グラフで表示

## 📝 注意事項

- Excelファイルは `.xlsx` または `.xls` 形式に対応しています
- 大量データ（10万行以上）の場合、集計に1-2分かかる場合があります
- Excel出力時の注意:
  - 各PT企業単体のダウンロード: 集計結果と生データの2シート構成
  - 全PT企業一括ダウンロード（生データ含む）: ファイルサイズが大きくなります（数十MB以上）
  - 生データシートには、選択したPT企業に絞られた交換記録のみが含まれます

## 🔧 トラブルシューティング

### パッケージのインストールエラー

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### ファイル読み込みエラー

- Excelファイルのフォーマットが正しいか確認してください
- 必須列（`user_company(所属)`, `user_name`, `自転車メーカー名`, `battery_remaining`）が存在するか確認してください
- ファイルが破損していないか確認してください

### 集計エラー

- データに欠損値が多い場合、集計結果に影響が出る可能性があります
- エラーメッセージを確認し、該当する行のデータを修正してください

## 🌐 デプロイ

このアプリケーションは、Streamlit Community Cloudで公開されています。

デプロイ方法の詳細は、以下のドキュメントを参照してください：
- `DEPLOYMENT.md`: 詳細なデプロイガイド
- `PUBLIC_DEPLOY.md`: パブリックリポジトリでの認証付きデプロイ
- `DEPLOY_OPTIONS.md`: デプロイオプションの選択ガイド

## 🔐 認証機能

パブリックリポジトリでのデプロイ時は、認証機能により不正アクセスを防止しています。
- ユーザー名とパスワードによるログイン
- パスワードはSHA256でハッシュ化して保存
- Streamlit Secrets機能を使用した安全な認証情報管理

## 📧 お問い合わせ

問題が発生した場合は、開発チームまでお問い合わせください。
