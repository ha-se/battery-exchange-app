# 🔋 バッテリー交換実績集計アプリ

PT企業（user_company）毎に、user_nameと自転車メーカー別のバッテリー交換実績を集計し、Snowflakeにアップロードするアプリケーションです。

## 📋 機能

- ✅ Excelファイル（バッテリー交換実績データ）の読み込み
- ✅ PT企業毎に自動集計
- ✅ user_name × 自転車メーカー名 のクロス集計表を生成
- ✅ インタラクティブなグラフ表示（棒グラフ、円グラフ）
- ✅ Excel形式での集計結果ダウンロード
- ✅ **Snowflakeへのデータアップロード（3つのモード）**
  - 📊 **生データアップロード（推奨）**: 全データをSnowflakeにアップロードし、SQL側で集計
  - 🔍 **集計済みデータアップロード**: Python側で集計した結果をアップロード
  - 🔄 **両方**: 生データと集計済みデータの両方をアップロード
- ✅ **Snowflake用SQL集計クエリの自動生成**

## 🚀 セットアップ

### 1. 必要なパッケージのインストール

```bash
pip install -r requirements.txt
```

### 2. アプリケーションの起動

```bash
streamlit run app.py
```

ブラウザが自動的に開き、アプリケーションが表示されます。

## 📖 使い方

### 基本的な使い方

1. **ファイルのアップロード**
   - サイドバーから「Excelファイルをアップロード」ボタンをクリック
   - バッテリー交換実績データのExcelファイルを選択

2. **集計実行**
   - 「🔄 集計実行」ボタンをクリック
   - PT企業毎に自動集計が実行されます

3. **結果の確認**
   - ドロップダウンからPT企業を選択
   - 以下の3つのタブで結果を確認できます：
     - **📋 集計表**: user_name × 自転車メーカー名のクロス集計表（基準内/基準外含む）
     - **📊 グラフ**: 棒グラフと円グラフでビジュアル表示（基準内/基準外の色分け）
     - **💾 Excel出力**: 集計結果と生データをExcelファイルとしてダウンロード
       - **各PT企業単体**: 「集計結果」シートと「生データ」シートの2シート構成
       - **全PT企業一括**: 集計のみ、または集計+生データから選択可能

### Snowflakeへのアップロード

1. **接続設定**
   - サイドバーのSnowflake接続設定に以下を入力：
     - Account: Snowflakeアカウント名（例: abc12345.ap-northeast-1.aws）
     - User: ユーザー名
     - Password: パスワード
     - Warehouse: ウェアハウス名（デフォルト: COMPUTE_WH）
     - Database: データベース名
     - Schema: スキーマ名（デフォルト: PUBLIC）
     - Table Name: テーブル名（デフォルト: BATTERY_EXCHANGE_SUMMARY）

2. **アップロードモードの選択**
   
   #### 📊 生データアップロード（推奨）
   - **メリット**:
     - ✅ Snowflakeで自由に集計・分析が可能
     - ✅ 高速な処理（Snowflakeのクラスタリング機能を活用）
     - ✅ SQLクエリで再集計が簡単
     - ✅ 他のメンバーもアクセス可能
   
   - **手順**:
     1. 「📊 生データ（推奨）」を選択
     2. テーブル名を入力（デフォルト: BATTERY_EXCHANGE_RAW）
     3. 「📤 生データをアップロード」ボタンをクリック
     4. 「📝 集計SQLを生成」ボタンで集計用SQLを取得
     5. 生成されたSQLをSnowflakeで実行してビューを作成
   
   #### 🔍 集計済みデータアップロード
   - Python側で集計した結果をアップロード
   - アップロードするPT企業を選択（複数選択可能）
   - 「☁️ 集計データをアップロード」ボタンをクリック
   
   #### 🔄 両方
   - 生データと集計済みデータの両方をアップロード
   - 柔軟性と即時性の両方を確保

## 📊 データ形式

### 入力データ（Excel）

必須列：
- `user_company(所属)`: PT企業名（V列）
- `user_name`: ユーザー名
- `自転車メーカー名`: 自転車のメーカー名
- `battery_remaining`: バッテリー残量（基準判定に使用）

### 出力データ（集計結果）

各PT企業毎に以下の形式で集計（基準内/基準外含む）：

| user_name | Panasonic_基準内 | Panasonic_基準外 | Panasonic_合計 | YAMAHA_基準内 | YAMAHA_基準外 | YAMAHA_合計 | ... | 総合計 |
|-----------|-----------------|----------------|--------------|-------------|-------------|------------|-----|-------|
| ユーザー1   | 80              | 20             | 100          | 45          | 5           | 50         | ... | 167   |
| ユーザー2   | 70              | 10             | 80           | 55          | 5           | 60         | ... | 159   |
| ...       | ...             | ...            | ...          | ...         | ...         | ...        | ... | ...   |
| 合計      | 150             | 30             | 180          | 100         | 10          | 110        | ... | 326   |

#### バッテリー残量基準

各メーカーの基準外判定：
- **Panasonic**: 25%以上が基準外（25%未満が基準内）
- **YAMAHA**: 70%以上が基準外（70%未満が基準内）
- **DBS**: 50%以上が基準外（ただし100%は基準内）
- **glafit**: 50%以上が基準外（50%未満が基準内）
- **シナネンサイクル**: 40%以上が基準外（40%未満が基準内）
- **KUROAD**: 基準判定なし

### Snowflakeテーブル構造

#### 生データテーブル（BATTERY_EXCHANGE_RAW）
元のExcelデータの全列がそのままアップロードされます（152,369行）

主要な列：
- `id`: レコードID
- `user_company_所属_`: PT企業名
- `user_name`: ユーザー名
- `自転車メーカー名`: 自転車のメーカー名
- `do_date`: 実施日
- その他、元データの全列

#### 集計ビュー（BATTERY_EXCHANGE_RAW_AGGREGATED）
生成されたSQLで作成されるビュー（基準内/基準外含む）：
- `pt_company`: PT企業名
- `user_name`: ユーザー名
- 各メーカー毎に：
  - `[メーカー名]_kijun_nai`: 基準内の件数
  - `[メーカー名]_kijun_gai`: 基準外の件数
  - `[メーカー名]_total`: 合計件数
- `grand_total`: 総合計件数

例：
- `panasonic_kijun_nai`, `panasonic_kijun_gai`, `panasonic_total`
- `yamaha_kijun_nai`, `yamaha_kijun_gai`, `yamaha_total`
- `dbs_kijun_nai`, `dbs_kijun_gai`, `dbs_total`
- etc.

#### 集計済みデータテーブル（BATTERY_EXCHANGE_SUMMARY）
Python側で集計したデータ：
- `PT企業名`: PT企業名
- `user_name`: ユーザー名
- `Panasonic`: Panasonic製自転車の件数
- `YAMAHA`: YAMAHA製自転車の件数
- `DBS`: DBS製自転車の件数
- `glafit`: glafit製自転車の件数
- `シナネンサイクル`: シナネンサイクル製自転車の件数
- `KUROAD`: KUROAD製自転車の件数
- `合計`: 合計件数

## 🛠️ 技術スタック

- **Python 3.9+**
- **Streamlit**: Webアプリケーションフレームワーク
- **Pandas**: データ処理・集計
- **Plotly**: インタラクティブなグラフ表示
- **Snowflake Connector**: Snowflakeへのデータアップロード
- **OpenPyXL**: Excelファイルの読み書き

## 💡 ベストプラクティス

### Snowflakeへのデータアップロード戦略

**推奨**: 生データをSnowflakeにアップロードし、SQL側で集計

**理由**:
1. **スケーラビリティ**: Snowflakeは大量データ処理に最適化されています
2. **柔軟性**: 生データがあれば、様々な角度から再集計が可能
3. **共同作業**: SQLクエリを共有することで、チーム全体でデータ分析が可能
4. **処理速度**: Snowflakeのクラスタリング機能により、大量データでも高速処理
5. **データの一元管理**: 単一のソースから様々なレポートを生成可能

### SQLクエリの活用例

生データをアップロード後、以下のような分析が可能になります：

```sql
-- 月別の推移分析
SELECT 
    DATE_TRUNC('month', do_date) as month,
    COUNT(*) as exchanges
FROM BATTERY_EXCHANGE_RAW
GROUP BY 1
ORDER BY 1;

-- エリア別の分析
SELECT 
    エリア,
    自転車メーカー名,
    COUNT(*) as count
FROM BATTERY_EXCHANGE_RAW
GROUP BY 1, 2
ORDER BY 1, 3 DESC;

-- 時間帯別の分析
SELECT 
    HOUR(do_date) as hour,
    COUNT(*) as exchanges
FROM BATTERY_EXCHANGE_RAW
GROUP BY 1
ORDER BY 1;
```

## 📝 注意事項

- Excelファイルは`.xlsx`または`.xls`形式に対応しています
- Snowflakeへのアップロードには適切な権限が必要です
- 生データのアップロードには30秒〜1分程度かかる場合があります
- 集計済みデータのアップロードは、データ量に応じて時間がかかります
- **Excel出力時の注意**:
  - 各PT企業単体のダウンロード: 集計結果と生データの2シート構成
  - 全PT企業一括ダウンロード（生データ含む）: ファイルサイズが大きくなります（数十MB以上）
  - 生データシートには、選択したPT企業に絞られた全152,369行のうち該当する行のみが含まれます

## 🔧 トラブルシューティング

### パッケージのインストールエラー

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### Snowflake接続エラー

- アカウント名、ユーザー名、パスワードが正しいか確認してください
- ネットワーク接続を確認してください
- Snowflakeのウェアハウスが起動しているか確認してください

## 📧 お問い合わせ

問題が発生した場合は、開発チームまでお問い合わせください。

